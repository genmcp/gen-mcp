name: Verify codegen

on:
  push:
    branches:
      - main
  pull_request:

jobs:
  verify:
    name: Verify Codegen
    runs-on: ubuntu-latest

    steps:
      - name: Checkout sources
        uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: Set up Go
        uses: actions/setup-go@v6
        with:
          go-version-file: 'go.mod'

      - name: Update Codegen
        shell: bash
        run: |
          make update-codegen

      - name: Verify
        shell: bash
        run: |
          # From: https://backreference.org/2009/12/23/how-to-match-newlines-in-sed/
          # This is to leverage this workaround:
          # https://github.com/actions/toolkit/issues/193#issuecomment-605394935
          function urlencode() {
            sed ':begin;$!N;s/\n/%0A/;tbegin'
          }
          
          if [[ -z "$(git status --porcelain)" ]]; then
              echo "${{ github.repository }} up to date."
          else
              # Print it both ways because sometimes we haven't modified the file (e.g. zz_generated),
              # and sometimes we have (e.g. configmap checksum).
              echo "Found diffs in: $(git diff-index --name-only HEAD --)"
              for x in $(git diff-index --name-only HEAD --); do
                  echo "::error file=$x::Please run `make update-codegen`.%0A$(git diff $x | urlencode)"
              done
              echo "${{ github.repository }} is out of date. Please run `make update-codegen`"
              exit 1
          fi
